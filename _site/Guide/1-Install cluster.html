<h1 id="install-cluster">Install cluster</h1>

<p>In this part we will setup Kubernetes cluster using <a href="https://github.com/rancher/k3os" target="_blank" rel="noopener noreferrer">K3os</a> which is operating system containing <a href="https://github.com/rancher/k3s" target="_blank" rel="noopener noreferrer">K3s</a> which is minimalised and bit simplified Kubernetes flavour. This meas that after finishing this part you will get fully functional cluster with minimum resource consumption.</p>

<h2 id="notes">Notes</h2>

<p>I have spend quite some time on this part for several reasons. I wanted Raspberry Pi to run 64-bit operating system which is tricky, because offical Raspberry OS was not available at the time I started and even now is not stable release and even then you have to setup all. K3os was obvious choice but it doesn‚Äôt have straightforward installation for Raspberry Pi. Thanks to <a href="https://github.com/sgielen" target="_blank" rel="noopener noreferrer">sgielen</a> who created <a href="https://github.com/sgielen/picl-k3os-image-generator" target="_blank" rel="noopener noreferrer">Raspberry Pi image generator</a>. I have used this generator and update it to latest version of <a href="https://github.com/raspberrypi/firmware/releases" target="_blank" rel="noopener noreferrer">Raspeberry Pi</a> and <a href="https://github.com/rancher/k3os" target="_blank" rel="noopener noreferrer">K3os</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ol>
  <li>3x Raspberry Pi</li>
  <li>3x MicroSDHC ( I‚Äôm using ‚ÄòSanDisk MicroSDHC 32GB Extreme A1 UHS-I (V30)‚Äô )</li>
  <li>3x Cooling case for Raspberry Pi ( I‚Äôm using ‚ÄòArmor Aluminum Alloy Case Protective Shell Metal Enclosure with Dual Fan for Raspberry Pi 4 Model B Only‚Äô but I will try ‚ÄòArgon One Raspberry Pi 4 Case‚Äô for next nodes )</li>
  <li>1x Ethernet switch</li>
  <li>4x Ethernet cabels</li>
  <li>Docker installed on your system</li>
  <li><a href="https://www.raspberrypi.org/downloads/" target="_blank" rel="noopener noreferrer">Raspberry Pi Imager</a></li>
</ol>

<h2 id="1-get-raspberry-pi-mac-addresses-and-assign-static-ip-adresses">1. Get Raspberry Pi MAC addresses and assign static IP adresses</h2>

<p>You need to burn Raspberry OS to one of your MicroSDHC and insert it into each of your Raspberry Pi and get MAC address of your eth0 interfaces. I would suggest to write numbers using pernament marker on each Raspberry Pi and then note each MAC address from <code class="language-plaintext highlighter-rouge">ifconfig eth0</code>.</p>

<h3 id="-headless-mode">üß∂ Headless mode</h3>

<p>You can do it without attaching monitor by addind empty file named <code class="language-plaintext highlighter-rouge">ssh</code> to boot partition on your MicroSDHC and then ssh into booted os. You will need access your router to get assigned IP address.</p>

<h3 id="assing-static-ip-addresses-on-your-home-router">Assing static IP addresses on your home router</h3>

<p>In order to prevent situation when Raspberry Pi will get different IP on each boot you have to make their IP static in DHCP server setting in your home router. Please note this IPs and for sake of simplicity replace all strings in this guide as follows MASTER_1_IP, WORKER_2_IP, WORKER_3_IP with their respective IP addresses.</p>

<h2 id="2-build-master-image">2. Build master image</h2>

<ol>
  <li>Under this guide find <a href="./config">./config</a> folder and apply following changes:
    <ul class="task-list">
      <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Change file names to your MAC addresses you have noted in previous step. Keep order, each config file contain comment to note which Rasperry Pi node number is it.</li>
      <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Set your own ssh public key under <code class="language-plaintext highlighter-rouge">ssh_authorized_keys</code> ( NOTE: github shortcut notation didn‚Äôt work for me ).</li>
      <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Update <code class="language-plaintext highlighter-rouge">ntp_servers</code> might be some public ntp server or if your router provide own use that one.</li>
      <li class="task-list-item">
<input type="checkbox" class="task-list-item-checkbox" disabled>Update <code class="language-plaintext highlighter-rouge">boot_cmd</code> to reflect your zone.</li>
    </ul>
  </li>
  <li>
    <p>Run master image build, please note that it take some time to fetch dependencies so go take coffee or stare at something ‚è≥.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>docker run -e TARGET=raspberrypi -v $PWD/config:/app/config -v $PWD/deps:/app/deps -v $PWD/out:/app/out -v /dev:/dev --privileged docker.io/elmariofredo/picl-k3os-image-generator:v0.2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Burn resulting image generated to <a href="./out">out</a> folder to MicroSDHC using Raspberry Pi Imager and put it into your Rapberry Pi marked as 1.</p>
  </li>
  <li>
    <p>Get kubeconfig file and verify that master is up and running</p>

    <p>ssh rancher@MASTER_1_IP sudo cat /etc/rancher/k3s/k3s.yaml | sed ‚Äòs/127.0.0.1/MASTER_1_IP/g‚Äô &gt; ./tmp/kube_config.yml
  export KUBECONFIG=./tmp/kube_config.yml
  kubectl get nodes
  #&gt; n1     Ready    master   20s   v1.18.6+k3s1</p>
  </li>
  <li>
    <p>Get join token from master node</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>ssh rancher@MASTER_1_IP sudo cat /var/lib/rancher/k3s/server/node-token
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="2-build-worker-image">2. Build worker image</h2>

<ol>
  <li>Update <code class="language-plaintext highlighter-rouge">server_url</code> under <a href="./config">config</a> folder for each worker</li>
  <li>Update <code class="language-plaintext highlighter-rouge">token</code> under <a href="./config">config</a> folder for each worker</li>
  <li>
    <p>Build image using same command</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>docker run -e TARGET=raspberrypi -v $PWD/config:/app/config -v $PWD/deps:/app/deps -v $PWD/out:/app/out -v /dev:/dev --privileged docker.io/elmariofredo/picl-k3os-image-generator:v0.2
</code></pre></div>    </div>
  </li>
  <li>Burn image to rest MicroSDHC using Raspberry Pi Imager and put it into rest of Raspberry Pi.</li>
  <li>Verify that workers have joined master properly by running <code class="language-plaintext highlighter-rouge">kubectl get nodes</code> again</li>
</ol>

<h2 id="3-done-">3. Done üé©</h2>
